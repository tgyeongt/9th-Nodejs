# [week07]ë°•íƒœê²½ ë¯¸ì…˜ ê¸°ë¡

## ë³µìŠµ

**Repository** â†’ DBì™€ ì§ì ‘ í†µì‹ í•˜ëŠ” ê³„ì¸µ (â†’ Prisma ì½”ë“œ ì‚¬ìš©)

**DTO** â†’ â€œë°ì´í„°ë¥¼ ì£¼ê³ ë°›ì„ ë•Œì˜ í˜•ì‹â€ì„ ì •ì˜í•˜ëŠ” ê³„ì¸µ

**Controller** â†’ í´ë¼ì´ì–¸íŠ¸ ìš”ì²­(req, res)ì„ ë°›ê³ , Serviceë¥¼ í˜¸ì¶œí•˜ëŠ” ê³„ì¸µ

**Service** â†’ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” ê³„ì¸µ

## ë¬¸ì œ 1 : Cannot read properties of undefined (reading 'map')

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2025-11-13 á„‹á…©á„’á…® 4.06.14.png](%5Bweek07%5D%EB%B0%95%ED%83%9C%EA%B2%BD%20%EB%AF%B8%EC%85%98%20%EA%B8%B0%EB%A1%9D/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2025-11-13_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_4.06.14.png)

## ì™œ ì´ëŸ° ë¬¸ì œê°€ ë°œìƒí–ˆëŠ”ê°€

responseFromUser()ì—ì„œ userFavorCategoriesê°€ undefinedì¼ ë•Œ map()ì„ í˜¸ì¶œí•¨.

## í•´ê²° ë°©ë²•

```jsx
export const responseFromUser = ({ user, userFavorCategories = [] }) => { // ì—¬ê¸°!!
  const preferFoods = userFavorCategories.map((ufc) => ufc.foodCategory.name);

  return {
    email: user.email,
    name: user.name,
    preferCategory: preferFoods,
    createdAt: dayjs(user.createdAt).tz("Asia/Seoul").toDate(),
    updatedAt: dayjs(user.updatedAt).tz("Asia/Seoul").toDate(),
  };
};
```

`user.dto.js` ì—ì„œ `userFavorCategories`ì˜ ê¸°ë³¸ ê°’ì„ ë¹ˆ ë°°ì—´ë¡œ ì„¤ì •í–ˆë”ë‹ˆ ì˜¤ë¥˜ê°€ í•´ê²°ëë‹¤.

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2025-11-13 á„‹á…©á„’á…® 5.40.46.png](%5Bweek07%5D%EB%B0%95%ED%83%9C%EA%B2%BD%20%EB%AF%B8%EC%85%98%20%EA%B8%B0%EB%A1%9D/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2025-11-13_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_5.40.46.png)

## ë¬¸ì œ 2 : **Provided value for column too long (password)**

## ì™œ ì´ëŸ° ë¬¸ì œê°€ ë°œìƒí–ˆëŠ”ê°€

Prisma ìŠ¤í‚¤ë§ˆì—ì„œ password ì»¬ëŸ¼ ê¸¸ì´ë¥¼ @db.VarChar(15)ë¡œ ì„¤ì •í–ˆëŠ”ë°, bcryptë¡œ ìƒì„±ëœ í•´ì‹œ ê¸¸ì´ëŠ” 60ìë¥¼ ì´ˆê³¼í–ˆë‹¤

## í•´ê²° ë°©ë²•

```jsx
password String @db.VarChar(60)
```

DB ì»¬ëŸ¼ ê¸¸ì´ë¥¼ 60ìœ¼ë¡œ ëŠ˜ë ¸ë‹¤.

bcryptë¡œ ìƒì„±ë˜ëŠ” í•´ì‹œ ê¸¸ì´ê°€ ìƒê°ë³´ë‹¤ ê¸¸êµ¬ë‚˜..

ì¤„ì¼ ìˆ˜ëŠ” ì—†ë‚˜ â†’ bcrypt ë§ê³  ë‹¤ë¥¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì¨ì•¼í•œë‹¤.

## ë¬¸ì œ 3 : **Foreign key constraint violated (food_category_id)**

## ì™œ ì´ëŸ° ë¬¸ì œê°€ ë°œìƒí–ˆëŠ”ê°€

UserFavorCategoryë¥¼ ìƒì„±í•  ë•Œ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” foodCategoryIdë¥¼ ì „ë‹¬

MySQLì—ì„œ ì™¸ë˜í‚¤ ì œì•½ì¡°ê±´ ìœ„ë°˜

## í•´ê²° ë°©ë²•

1. ë¨¼ì € FoodCategoryì— í•„ìš”í•œ ë°ì´í„° ì‚½ì…:

```sql
mysql> INSERT INTO FoodCategory (name) VALUES ('í•œì‹'), ('ì–‘ì‹'), ('ì¤‘ì‹'), ('ë””ì €íŠ¸'), ('ì¼ì‹'), ('ë¶„ì‹');
```

2. setPreference() í˜¸ì¶œ ì‹œ ì‹¤ì œ ì¡´ì¬í•˜ëŠ” foodCategoryId ì‚¬ìš©.

## ë¬¸ì œ 4 : **ArgumentÂ userId is missing (userMission.findMany)**

## ì™œ ì´ëŸ° ë¬¸ì œê°€ ë°œìƒí–ˆëŠ”ê°€

findManyì—ì„œ where ì¡°ê±´ì— userIdê°€ ì „ë‹¬ë˜ì§€ ì•ŠìŒ

Prismaê°€ í•„ìˆ˜ í•„ë“œ ì—†ì´ filterë¥¼ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŒ

## í•´ê²° ë°©ë²•

```jsx
const where = { userId: Number(userId) };
if (status) where.status = status;

await prisma.userMission.findMany({ where, include: { mission: true } });
```

í•„ìˆ˜ ì¡°ê±´(userId)ì„ í•­ìƒ ì „ë‹¬í•˜ë„ë¡ ìˆ˜ì •

<aside>
ğŸ’¡

### select vs. include

### **1. select**

- íŠ¹ì • ì»¬ëŸ¼ë§Œ ê°€ì ¸ì˜¤ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©
- ì˜ˆ: select: { id: true, status: true } â†’ ë‚˜ë¨¸ì§€ ì»¬ëŸ¼ì€ ì œì™¸
- ë°˜í™˜ë˜ëŠ” ê°ì²´ì— **ì„ íƒí•œ ì»¬ëŸ¼ë§Œ** ë“¤ì–´ê°

### **2. include**

- ê´€ê³„í˜• í•„ë“œë¥¼ í¬í•¨í•´ì„œ ê°€ì ¸ì˜¤ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©
- ì˜ˆ: include: { mission: true } â†’ userMissionê³¼ ê´€ë ¨ëœ **Mission ê°ì²´ ì „ì²´**ë„ ê°™ì´ ë°˜í™˜
- ë°˜í™˜ë˜ëŠ” ê°ì²´ì— **userMission + mission ì „ì²´ ê°ì²´**ê°€ ë“¤ì–´ê°
</aside>

## ë¬¸ì œ 5 : **ì‚¬ì´íŠ¸ ì—°ê²° ê±°ë¶€ (ERR_CONNECTION_REFUSED)**

## ì™œ ì´ëŸ° ë¬¸ì œê°€ ë°œìƒí–ˆëŠ”ê°€

```sql
import express from 'express';
import cookieParser from 'cookie-parser';
import morgan from 'morgan';

const app = express();
app.use(morgan('dev'));  // ë¡œê·¸ í¬ë§·: dev
app.use(cookieParser()); 

app.get('/test', (req, res) => {
  res.send('Hello!');
});

// ì¿ í‚¤ ë§Œë“œëŠ” ë¼ìš°í„° 
app.get('/setcookie', (req, res) => {
    // 'myCookie'ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ 'hello' ê°’ì„ ê°€ì§„ ì¿ í‚¤ë¥¼ ìƒì„±
    res.cookie('myCookie', 'hello', { maxAge: 60000 }); // 60ì´ˆê°„ ìœ íš¨
    res.send('ì¿ í‚¤ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
});

// ì¿ í‚¤ ì½ëŠ” ë¼ìš°í„° 
app.get('/getcookie', (req, res) => {
    // cookie-parser ë•ë¶„ì— req.cookies ê°ì²´ì—ì„œ ë°”ë¡œ êº¼ë‚´ ì“¸ ìˆ˜ ìˆìŒ
    const myCookie = req.cookies.myCookie; 
    
    if (myCookie) {
        console.log(req.cookies); // { myCookie: 'hello' }
        res.send(`ë‹¹ì‹ ì˜ ì¿ í‚¤: ${myCookie}`);
    } else {
        res.send('ì¿ í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
    }
});

```

ì›Œí¬ë¶ì— ìˆëŠ” ì‹¤ìŠµ ì½”ë“œë¥¼ ë³µë¶™í•´ì„œ ì‹¤í–‰í•´ë´¤ìœ¼ë‚˜ ì‚¬ì´íŠ¸ ì—°ê²° ê±°ë¶€ ë©”ì„¸ì§€ê°€ ë‚˜ì˜´

Express ì„œë²„ê°€ ì‹¤í–‰ë˜ì—ˆìœ¼ë‚˜ í¬íŠ¸ê°€ ì—´ë¦¬ì§€ ì•Šì•˜ìŒ

## í•´ê²° ë°©ë²•

```jsx
app.listen(3000, () => console.log("Server running on http://localhost:3000"));
```

í•´ë‹¹ ì½”ë“œë¥¼ ì¶”ê°€í–ˆë”ë‹ˆ ì •ìƒ ì‹¤í–‰

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2025-11-12 á„‹á…©á„’á…® 11.45.30.png](%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2025-11-12_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_11.45.30.png)

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2025-11-12 á„‹á…©á„’á…® 11.45.41.png](%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2025-11-12_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_11.45.41.png)

## 7ì£¼ì°¨ ì›Œí¬ë¶ì— ì†Œê°œë˜ì—ˆë˜ `morgan` , `cookie-parser` ë“±ì„ ë³¸ì¸ì˜ í”„ë¡œì íŠ¸ ë©”ì¸ íŒŒì¼ (`index.js` ë“±)ì— `npm install` í•˜ê³  `app.use()` ë¡œ ì ìš©í•´ ì£¼ì„¸ìš”.

`index.js`

```sql
import dotenv from "dotenv";
import express from "express";
import cors from "cors";
import morgan from "morgan";
import cookieParser from "cookie-parser";
import { handleUserSignUp } from "./controllers/user.controller.js";
import { handleAddStore } from "./controllers/store.controller.js";
import {
  handleAddReview,
  handleListStoreReviews,
  handleListUserReviews,
} from "./controllers/review.controller.js";
import {
  handleChallengeMission,
  handleListStoreMissions,
  handleListUserMissions,
  handleCompleteMission,
} from "./controllers/mission.controller.js";

dotenv.config();

const app = express();
const port = process.env.PORT;

// ------------------- ê³µí†µ ì‘ë‹µ í—¬í¼ -------------------

app.use((req, res, next) => {
  res.success = (success) => {
    return res.json({ resultType: "SUCCESS", error: null, success });
  };

  res.error = ({ errorCode = "unknown", reason = null, data = null }) => {
    return res.json({
      resultType: "FAIL",
      error: { errorCode, reason, data },
      success: null,
    });
  };

  next();
});

// ------------------- ë¯¸ë“¤ì›¨ì–´ ì ìš© -------------------

// ìš”ì²­ ë¡œê¹… (morgan)
app.use(morgan("dev"));

// ì¿ í‚¤ ì²˜ë¦¬ (cookie-parser)
app.use(cookieParser());

// CORS í—ˆìš©
app.use(cors());

// ì •ì  íŒŒì¼ ì ‘ê·¼
app.use(express.static("public"));

// JSON, URL-encoded ìš”ì²­ ì²˜ë¦¬
app.use(express.json());
app.use(express.urlencoded({ extended: false }));

// ------------------- ë¼ìš°íŒ… -------------------

app.get("/", (req, res) => {
  res.send("Hello World!");
});

/* users */
// íšŒì›ê°€ì…
app.post("/api/v1/users/signup", handleUserSignUp);

// ë‚´ê°€ ì‘ì„±í•œ ë¦¬ë·° ëª©ë¡
app.get("/api/v1/users/:userId/reviews", handleListUserReviews);

// ë‚´ê°€ ì§„í–‰ ì¤‘ì¸ ë¯¸ì…˜ ëª©ë¡
app.get("/api/v1/users/:userId/missions", handleListUserMissions);

/* stores */
// íŠ¹ì • ì§€ì—­ì— ê°€ê²Œ ì¶”ê°€í•˜ê¸°
app.post("/api/v1/stores", handleAddStore);

// íŠ¹ì • ê°€ê²Œì— ë¦¬ë·° ì¶”ê°€í•˜ê¸°
app.post("/api/v1/stores/:storeId/reviews", handleAddReview);

// íŠ¹ì • ê°€ê²Œ ë¦¬ë·° ì¡°íšŒí•˜ê¸°
app.get("/api/v1/stores/:storeId/reviews", handleListStoreReviews);

// íŠ¹ì • ê°€ê²Œì˜ ë¯¸ì…˜ ëª©ë¡ ì¡°íšŒí•˜ê¸°
app.get("/api/v1/stores/:storeId/missions", handleListStoreMissions);

/* missions */
// ë¯¸ì…˜ ë„ì „í•˜ê¸°
app.post("/api/v1/missions/:missionId/challenge", handleChallengeMission);

// ì§„í–‰ ì¤‘ì¸ ë¯¸ì…˜ ì™„ë£Œ ì²˜ë¦¬
app.patch("/api/v1/missions/:missionId/complete", handleCompleteMission);

// ------------------- ì „ì—­ ì˜¤ë¥˜ í•¸ë“¤ëŸ¬ -------------------

app.use((err, req, res, next) => {
  if (res.headersSent) {
    return next(err);
  }

  res.status(err.statusCode || 500).error({
    errorCode: err.errorCode || "unknown",
    reason: err.reason || err.message || null,
    data: err.data || null,
  });
});

// ì„œë²„ ì‹œì‘
app.listen(port, () => {
  console.log(`Example app listening on port ${port}`);
});

```

`mission.dto.js`

```sql
import dayjs from "dayjs";
import utc from "dayjs/plugin/utc.js";
import timezone from "dayjs/plugin/timezone.js";

dayjs.extend(utc);
dayjs.extend(timezone);

export const bodyToChallenge = (body) => ({
  missionId: body.missionId,
  userId: 1,
  status: "in_progress",
});

export const responseFromChallenge = (data) => ({
  id: data.id,
  missionId: data.missionId,
  userId: data.userId,
  status: data.status,
  completedAt: data.completedAt
    ? dayjs(data.completedAt).tz("Asia/Seoul").toDate()
    : null,
  createdAt: dayjs(data.createdAt).tz("Asia/Seoul").toDate(),
});

```

`review.dto.js`

```sql
import dayjs from "dayjs";
import utc from "dayjs/plugin/utc.js";
import timezone from "dayjs/plugin/timezone.js";

dayjs.extend(utc);
dayjs.extend(timezone);

export const bodyToReview = (body) => ({
  storeId: body.storeId,
  body: body.body,
  score: body.score,
  userId: 1,
});

export const responseFromReview = (review) => ({
  id: review.id,
  storeId: review.storeId,
  userId: review.userId,
  body: review.body,
  score: review.score,
  createdAt: dayjs(review.createdAt).tz("Asia/Seoul").toDate(),
  updatedAt: review.updatedAt
    ? dayjs(review.updatedAt).tz("Asia/Seoul").toDate()
    : null,
});

```

`store.dto.js`

```sql
import dayjs from "dayjs";
import utc from "dayjs/plugin/utc.js";
import timezone from "dayjs/plugin/timezone.js";

dayjs.extend(utc);
dayjs.extend(timezone);

export const bodyToStore = (body) => {
  return {
    regionId: body.regionId,
    name: body.name,
    address: body.address,
  };
};

export const responseFromStore = (store) => ({
  id: store.id,
  name: store.name,
  address: store.address,
  regionId: store.regionId,
  createdAt: dayjs(store.createdAt).tz("Asia/Seoul").toDate(),
  updatedAt: store.updatedAt
    ? dayjs(store.updatedAt).tz("Asia/Seoul").toDate()
    : null,
});

```

`user.dto.js`

```sql
import dayjs from "dayjs";
import utc from "dayjs/plugin/utc.js";
import timezone from "dayjs/plugin/timezone.js";

dayjs.extend(utc);
dayjs.extend(timezone);

export const bodyToUser = (body) => {
  const birth = dayjs(body.birth).tz("Asia/Seoul").toDate();

  const now = dayjs().tz("Asia/Seoul");
  const age = now.year() - dayjs(birth).year();

  const userData = {
    email: body.email,
    name: body.name,
    gender: body.gender,
    birth,
    age,
    address: body.address || "",
    detailAddress: body.detailAddress || "",
    phoneNumber: body.phoneNumber,
    password: body.password,
    status: "active",
    socialType: "local",
    inactiveDate: null,
    point: 0,
    createdAt: now.toDate(),
    updatedAt: now.toDate(),
  };

  const preferenceIds = Array.isArray(body.preferences)
    ? body.preferences.map(Number)
    : [];

  return { userData, preferenceIds };
};

export const responseFromUser = ({ user, userFavorCategories = [] }) => {
  const preferFoods = userFavorCategories.map((ufc) => ufc.foodCategory.name);

  return {
    email: user.email,
    name: user.name,
    preferCategory: preferFoods,
    createdAt: dayjs(user.createdAt).tz("Asia/Seoul").toDate(),
    updatedAt: dayjs(user.updatedAt).tz("Asia/Seoul").toDate(),
  };
};

```