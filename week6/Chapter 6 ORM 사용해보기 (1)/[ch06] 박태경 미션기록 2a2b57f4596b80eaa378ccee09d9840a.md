# [ch06] 박태경 미션기록

**”내가 진행 중인 미션 목록의 엔드포인트”가 왜 `/api/v1/users/:userId/missions` 인가?**

<aside>
💡

이 엔드포인트는 “특정 유저가 진행 중인 미션 목록을 가져오는 기능”이다.

즉, 유저(user)가 주체

- /api/v1/stores/:storeId/missions → “이 가게에 어떤 미션이 있는지?”
    
    → 가게(store)가 주체
    
- /api/v1/users/:userId/missions → “이 유저가 어떤 미션을 진행 중인지?”
    
    → 유저(user)가 주체
    

“어떤 리소스의 하위 데이터인가?” 를 기준으로 URL을 설계해야 한다.

</aside>

**실습에서는 가게에 속한 모든 리뷰를 조회할 수 있는 API를 store에 작성했다. 왜 review가 아닌 store에 작성한거지?**

<aside>
💡

이 부분은 review에 코드를 작성하는 것이 맞다고 판단했다.

애초에 review 자체가 store에 종속될 수 밖에 없다. (가게가 없다면 당연히 리뷰도 없기 때문)

하지만 review에 필요한 API가 많기 때문에 유지보수 측면을 고려해서 review를 따로 분리한 것이다.

review에 필요한 API가 몇 없었다면 store에 작성할 수도 있었을 것이라고 생각한다.

</aside>

`index.js`

```tsx
import dotenv from "dotenv";
import express from "express";
import cors from "cors";
import { handleUserSignUp } from "./controllers/user.controller.js";
import { handleAddStore } from "./controllers/store.controller.js";
import {
  handleAddReview,
  handleListStoreReviews,
  handleListUserReviews,
} from "./controllers/review.controller.js";
import {
  handleChallengeMission,
  handleListStoreMissions,
  handleListUserMissions,
  handleCompleteMission,
} from "./controllers/mission.controller.js";

dotenv.config();

const app = express();
const port = process.env.PORT;

app.use(cors()); // cors 방식 허용
app.use(express.static("public")); // 정적 파일 접근

// request의 본문을 json으로 해석할 수 있도록 함 (JSON 형태의 요청 body를 파싱하기 위함)
app.use(express.json());

// 단순 객체 문자열 형태로 본문 데이터 해석
app.use(express.urlencoded({ extended: false }));

app.get("/", (req, res) => {
  res.send("Hello World!");
});

/* users */
// 회원가입
app.post("/api/v1/users/signup", handleUserSignUp);

// 내가 작성한 리뷰 목록
app.get("/api/v1/users/:userId/reviews", handleListUserReviews);

// 내가 진행 중인 미션 목록
app.get("/api/v1/users/:userId/missions", handleListUserMissions);

/* stores */
// 특정 지역에 가게 추가하기
app.post("/api/v1/stores", handleAddStore);

// 특정 가게에 리뷰 추가하기
app.post("/api/v1/stores/:storeId/reviews", handleAddReview);

// 특정 가게 리뷰 조회하기
app.get("/api/v1/stores/:storeId/reviews", handleListStoreReviews);

// 특정 가게의 미션 목록 조회하기
app.get("/api/v1/stores/:storeId/missions", handleListStoreMissions);

/* missions */
// 미션 도전하기
app.post("/api/v1/missions/:missionId/challenge", handleChallengeMission);

// 진행 중인 미션 완료 처리
app.patch("/api/v1/missions/:missionId/complete", handleCompleteMission);

app.listen(port, () => {
  console.log(`Example app listening on port ${port}`);
});

```

`mission.repository.js`

```tsx
import { prisma } from "../db.config.js";

// 특정 유저가 특정 미션에 참여 중인지 확인
export const getUserMission = async (userId, missionId) => {
  const mission = await prisma.user_mission.findFirst({
    where: {
      user_id: userId,
      mission_id: missionId,
    },
  });
  return mission; // 없으면 null
};

// 유저가 미션 도전 시작
export const insertUserMission = async (userId, missionId) => {
  const created = await prisma.user_mission.create({
    data: {
      user_id: userId,
      mission_id: missionId,
      status: "도전중",
    },
  });
  return created;
};

// 특정 가게의 모든 미션 목록
export const getMissionsByStore = async (storeId) => {
  return await prisma.mission.findMany({
    where: { store_id: Number(storeId) },
    orderBy: { id: "asc" },
  });
};

// 특정 유저의 모든 미션 목록
export const getUserMissions = async (userId, status) => {
  const where = { user_id: Number(userId) };
  if (status) where.status = status;

  return await prisma.userMission.findMany({
    where,
    include: { mission: true },
    orderBy: { id: "asc" },
  });
};

// 미션 완료 처리
export const completeUserMission = async (missionId) => {
  return await prisma.userMission.update({
    where: { id: Number(missionId) },
    data: {
      status: "완료",
      completed_at: new Date(),
    },
  });
};

```

`mission.service.js`

```tsx
import {
  getMissionsByStore,
  getUserMissions,
  completeUserMission,
  insertUserMission,
} from "../repositories/mission.repository.js";

// 특정 가게의 미션 목록 조회
export const listStoreMissions = async (storeId) => {
  return await getMissionsByStore(storeId);
};

// 특정 유저의 미션 목록 조회
export const listUserMissions = async (userId, status) => {
  return await getUserMissions(userId, status);
};

// 미션 완료 처리
export const completeMissionService = async (missionId) => {
  const updated = await completeUserMission(missionId);
  return updated;
};

export const challengeMissionService = async (userId, missionId) => {
  // 이미 도전 중인지 확인
  const existing = await prisma.user_mission.findFirst({
    where: { user_id: userId, mission_id: missionId },
  });

  if (existing) {
    throw new Error("이미 도전 중인 미션입니다.");
  }

  // 새로운 미션 도전 생성
  const mission = await insertUserMission(userId, missionId);
  return mission;
};

```

`review.repository.js`

```tsx
import { prisma } from "../db.config.js";

// 리뷰 추가
export const addReview = async (data) => {
  const created = await prisma.review.create({
    data: {
      storeId: data.storeId,
      userId: data.userId,
      body: data.body,
      score: data.score,
      createdAt: new Date(),
      updatedAt: new Date(),
    },
    include: {
      user: true,
      store: true,
      images: true,
    },
  });

  return created;
};

// 특정 가게의 리뷰 목록 (커서 기반 페이지네이션)
export const getAllStoreReviews = async (storeId, cursor = null, take = 5) => {
  const whereClause = {
    storeId: Number(storeId),
  };

  if (cursor) {
    whereClause.id = { gt: Number(cursor) };
  }

  const reviews = await prisma.review.findMany({
    where: whereClause,
    select: {
      id: true,
      content: true,
      storeId: true,
      userId: true,
      store: true,
      user: true,
      images: true,
    },
    orderBy: { id: "asc" },
    take,
  });

  return reviews;
};

// 내가 작성한 리뷰 목록
export const getReviewsByUser = async (userId) => {
  return await prisma.review.findMany({
    where: { userId: Number(userId) },
    include: {
      store: true,
    },
    orderBy: { id: "desc" },
  });
};

```

`review.service.js`

```tsx
import {
  addReview,
  getAllStoreReviews,
  getReviewsByUser,
} from "../repositories/review.repository.js";
import { getStoreById } from "../repositories/store.repository.js";
import { responseFromReview } from "../dtos/review.dto.js";

export const addReviewService = async (data) => {
  const store = await getStoreById(data.storeId);
  if (!store) throw new Error("존재하지 않는 가게입니다.");

  const review = await addReview(data);
  return responseFromReview(review);
};

export const listStoreReviews = async (storeId) => {
  const reviews = await getAllStoreReviews(storeId);
  return responseFromReview(reviews);
};

export const listUserReviews = async (userId) => {
  const reviews = await getReviewsByUser(userId);
  return reviews;
};

```