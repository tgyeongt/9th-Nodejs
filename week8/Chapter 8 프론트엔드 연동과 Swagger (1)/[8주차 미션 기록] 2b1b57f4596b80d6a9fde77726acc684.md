# [8주차 미션 기록]

![스크린샷 2025-11-20 오후 12.24.45.png](%5B8%EC%A3%BC%EC%B0%A8%20%EB%AF%B8%EC%85%98%20%EA%B8%B0%EB%A1%9D%5D/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2025-11-20_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_12.24.45.png)

#swagger.tags 을 추가해서 관련 도메인끼리 묶었다.

<aside>
❓

/api/v1/stores/{storeId}/missions 이 api의 코드가 missions 레포지토리와 서비스에 있다 

이래도 괜찮은지..?

</aside>

<aside>
❓

ts를 사용해서 swagger를 정리하려고 했는데 그러려면 모든 파일을 ts로 바꿔야하나..?

tsoa 라이브러리를 사용해서 swagger 채우는 걸 시도해봤으나 모든 파일을 바꿔야 한다고 해서 패스

</aside>

- mission.controller.js
    
    ```sql
    import { StatusCodes } from "http-status-codes";
    import { bodyToChallenge } from "../dtos/mission.dto.js";
    import {
      listStoreMissions,
      listUserMissions,
      challengeMissionService,
      completeMissionService,
    } from "../services/mission.service.js";
    
    export const handleChallengeMission = async (req, res, next) => {
      /*
        #swagger.summary = '미션 도전하기 API'
        #swagger.tags = ['Missions']
        #swagger.requestBody = {
          required: true,
          content: {
            "application/json": {
              schema: {
                type: "object",
                properties: {
                  userId: { type: "number", example: 7 },
                  missionId: { type: "number", example: 3 }
                }
              }
            }
          }
        }
        #swagger.responses[201] = {
          description: "미션 도전 성공",
          content: {
            "application/json": {
              schema: {
                type: "object",
                properties: {
                  result: {
                    type: "object",
                    properties: {
                      id: { type: "number", example: 11 },
                      missionId: { type: "number", example: 3 },
                      userId: { type: "number", example: 7 },
                      status: { type: "string", example: "도전중" },
                      startedAt: { type: "string", example: "2025-01-10T12:00:00+09:00" }
                    }
                  }
                }
              }
            }
          }
        }
      */
    
      try {
        const mission = await challengeMissionService(bodyToChallenge(req.body));
        res.status(StatusCodes.CREATED).json({ result: mission });
      } catch (err) {
        res.status(StatusCodes.BAD_REQUEST).json({ message: err.message });
      }
    };
    
    // 특정 가게의 미션 목록
    export const handleListStoreMissions = async (req, res) => {
      /*
        #swagger.summary = '특정 가게의 미션 목록 조회 API'
        #swagger.tags = ['Missions']
        #swagger.parameters['storeId'] = {
          in: 'path',
          required: true,
          description: '상점 ID',
          type: 'number',
          example: 3
        }
    
        #swagger.responses[200] = {
          description: "가게 미션 목록 조회 성공",
          content: {
            "application/json": {
              schema: {
                type: "object",
                properties: {
                  missions: {
                    type: "array",
                    items: {
                      type: "object",
                      properties: {
                        id: { type: "number", example: 4 },
                        storeId: { type: "number", example: 3 },
                        title: { type: "string", example: "음식 사진 인증하기" },
                        reward: { type: "string", example: "100포인트" },
                        description: { type: "string", example: "사진 업로드 시 포인트 지급" }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      */
      try {
        const { storeId } = req.params;
        const missions = await listStoreMissions(storeId);
        res.status(StatusCodes.OK).json({ missions });
      } catch (err) {
        res.status(StatusCodes.BAD_REQUEST).json({ message: err.message });
      }
    };
    
    // 특정 유저의 미션 목록 (status: 도전중 / 완료)
    export const handleListUserMissions = async (req, res) => {
      /*
        #swagger.summary = '사용자의 미션 목록 조회 API'
        #swagger.tags = ['Missions']
        #swagger.parameters['userId'] = {
          in: 'path',
          required: true,
          description: '유저 ID',
          type: 'number',
          example: 7
        }
        #swagger.parameters['status'] = {
          in: 'query',
          required: false,
          description: '미션 상태 필터 (도전중 | 완료)',
          type: 'string',
          example: '도전중'
        }
    
        #swagger.responses[200] = {
          description: "사용자 미션 목록 조회 성공",
          content: {
            "application/json": {
              schema: {
                type: "object",
                properties: {
                  missions: {
                    type: "array",
                    items: {
                      type: "object",
                      properties: {
                        id: { type: "number", example: 12 },
                        missionId: { type: "number", example: 3 },
                        userId: { type: "number", example: 7 },
                        status: { type: "string", example: "도전중" },
                        startedAt: { type: "string", example: "2025-01-11T13:00:00+09:00" },
                        completedAt: { type: "string", example: null }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      */
      try {
        const { userId } = req.params;
        const { status } = req.query; // ?status=도전중 같은 식으로 필터링
        const missions = await listUserMissions(userId, status);
        res.status(StatusCodes.OK).json({ missions });
      } catch (err) {
        res.status(StatusCodes.BAD_REQUEST).json({ message: err.message });
      }
    };
    
    // 미션 완료 처리
    export const handleCompleteMission = async (req, res) => {
      /*
        #swagger.summary = '미션 완료 처리 API'
        #swagger.tags = ['Missions']
        #swagger.parameters['missionId'] = {
          in: 'path',
          required: true,
          type: 'number',
          example: 3,
          description: '완료 처리할 missionId'
        }
    
        #swagger.responses[200] = {
          description: "미션 완료 성공",
          content: {
            "application/json": {
              schema: {
                type: "object",
                properties: {
                  result: {
                    type: "object",
                    properties: {
                      missionId: { type: "number", example: 3 },
                      status: { type: "string", example: "완료" },
                      completedAt: { type: "string", example: "2025-01-15T14:00:00+09:00" }
                    }
                  }
                }
              }
            }
          }
        }
      */
      try {
        const { missionId } = req.params;
        const result = await completeMissionService(missionId);
        res.status(StatusCodes.OK).json({ result });
      } catch (err) {
        res.status(StatusCodes.BAD_REQUEST).json({ message: err.message });
      }
    };
    
    ```
    
- review.controller.js
    
    ```sql
    import { StatusCodes } from "http-status-codes";
    import { bodyToReview } from "../dtos/review.dto.js";
    import {
      addReviewService,
      listStoreReviews,
    } from "../services/review.service.js";
    
    export const handleAddReview = async (req, res, next) => {
      /*
        #swagger.summary = '리뷰 추가 API';
        #swagger.tags = ['Stores']
        #swagger.parameters['storeId'] = {
          in: 'path',
          required: true,
          description: '리뷰를 작성할 상점 ID',
          type: 'number'
        }
        #swagger.requestBody = {
          required: true,
          content: {
            "application/json": {
              schema: {
                type: "object",
                properties: {
                  content: { type: "string", example: "정말 맛있는 가게예요!" },
                  score: { type: "number", example: 5 }
                }
              }
            }
          }
        }
        #swagger.responses[201] = {
          description: "리뷰 생성 성공",
          content: {
            "application/json": {
              schema: {
                type: "object",
                properties: {
                  result: {
                    type: "object",
                    properties: {
                      id: { type: "number", example: 12 },
                      storeId: { type: "number", example: 3 },
                      userId: { type: "number", example: 7 },
                      content: { type: "string", example: "정말 맛있어요!" },
                      score: { type: "number", example: 5 }
                    }
                  }
                }
              }
            }
          }
        }
      */
      try {
        const reviewData = {
          ...bodyToReview(req.body),
          storeId: Number(req.params.storeId),
        };
    
        const review = await addReviewService(reviewData);
    
        res.status(StatusCodes.CREATED).json({ result: review });
      } catch (err) {
        console.error(err);
        res.status(StatusCodes.BAD_REQUEST).json({ message: err.message });
      }
    };
    
    export const handleListStoreReviews = async (req, res, next) => {
      /*
        #swagger.summary = '상점 리뷰 목록 조회 API';
        #swagger.tags = ['Stores']
        #swagger.responses[200] = {
          description: "상점 리뷰 목록 조회 성공 응답",
          content: {
            "application/json": {
              schema: {
                type: "object",
                properties: {
                  resultType: { type: "string", example: "SUCCESS" },
                  error: { type: "object", nullable: true, example: null },
                  success: {
                    type: "object",
                    properties: {
                      data: {
                        type: "array",
                        items: {
                          type: "object",
                          properties: {
                            id: { type: "number" },
                            store: { type: "object", properties: { id: { type: "number" }, name: { type: "string" } } },
                            user: { type: "object", properties: { id: { type: "number" }, email: { type: "string" }, name: { type: "string" } } },
                            content: { type: "string" }
                          }
                        }
                      },
                      pagination: { type: "object", properties: { cursor: { type: "number", nullable: true } }}
                    }
                  }
                }
              }
            }
          }
        };
      */
      try {
        const storeId = Number(req.params.storeId);
        const reviews = await listStoreReviews(storeId);
        res.status(StatusCodes.OK).json({ reviews });
      } catch (err) {
        console.error(err);
        res
          .status(StatusCodes.INTERNAL_SERVER_ERROR)
          .json({ message: err.message });
      }
    };
    
    ```
    
- store.controller.js
    
    ```sql
    import { StatusCodes } from "http-status-codes";
    import { bodyToStore } from "../dtos/store.dto.js";
    import { addStoreService } from "../services/store.service.js";
    
    export const handleAddStore = async (req, res, next) => {
      /*
        #swagger.summary = '가게 추가 API'
        #swagger.tags = ['Stores']
        #swagger.requestBody = {
          required: true,
          content: {
            "application/json": {
              schema: {
                type: "object",
                properties: {
                  name: { type: "string", example: "홍길동식당" },
                  address: { type: "string", example: "서울 강남구 테헤란로 123" },
                  category: { type: "string", example: "한식" }
                }
              }
            }
          }
        }
        #swagger.responses[201] = {
          description: "가게 등록 성공",
          content: {
            "application/json": {
              schema: {
                type: "object",
                properties: {
                  result: {
                    type: "object",
                    properties: {
                      id: { type: "number", example: 15 },
                      name: { type: "string", example: "홍길동식당" },
                      address: { type: "string", example: "서울 강남구 테헤란로 123" },
                      category: { type: "string", example: "한식" }
                    }
                  }
                }
              }
            }
          }
        }
      */
    
      try {
        const store = await addStoreService(bodyToStore(req.body));
        res.status(StatusCodes.CREATED).json({ result: store });
      } catch (err) {
        res.status(StatusCodes.BAD_REQUEST).json({ message: err.message });
      }
    };
    
    ```
    
- user.controller.js
    
    ```sql
    import { StatusCodes } from "http-status-codes";
    import { bodyToUser } from "../dtos/user.dto.js";
    import { userSignUp } from "../services/user.service.js";
    
    export const handleUserSignUp = async (req, res, next) => {
      console.log("회원가입을 요청했습니다!");
      console.log("body:", req.body);
      /*
        #swagger.summary = '회원 가입 API';
        #swagger.tags = ['Users']
        #swagger.requestBody = {
          required: true,
          content: {
            "application/json": {
              schema: {
                type: "object",
                properties: {
                  email: { type: "string" },
                  name: { type: "string" },
                  gender: { type: "string" },
                  birth: { type: "string", format: "date" },
                  address: { type: "string" },
                  detailAddress: { type: "string" },
                  phoneNumber: { type: "string" },
                  preferences: { type: "array", items: { type: "number" } }
                }
              }
            }
          }
        };
        #swagger.responses[200] = {
          description: "회원 가입 성공 응답",
          content: {
            "application/json": {
              schema: {
                type: "object",
                properties: {
                  resultType: { type: "string", example: "SUCCESS" },
                  error: { type: "object", nullable: true, example: null },
                  success: {
                    type: "object",
                    properties: {
                      email: { type: "string" },
                      name: { type: "string" },
                      preferCategory: { type: "array", items: { type: "string" } }
                    }
                  }
                }
              }
            }
          }
        };
        #swagger.responses[400] = {
          description: "회원 가입 실패 응답",
          content: {
            "application/json": {
              schema: {
                type: "object",
                properties: {
                  resultType: { type: "string", example: "FAIL" },
                  error: {
                    type: "object",
                    properties: {
                      errorCode: { type: "string", example: "U001" },
                      reason: { type: "string" },
                      data: { type: "object" }
                    }
                  },
                  success: { type: "object", nullable: true, example: null }
                }
              }
            }
          }
        };
      */
      try {
        const { userData, preferenceIds } = bodyToUser(req.body);
    
        const user = await userSignUp({
          ...userData,
          preferences: preferenceIds,
        });
    
        res.status(StatusCodes.OK).success(user);
      } catch (error) {
        next(error);
      }
    };
    
    // 내가 작성한 리뷰 목록
    export const handleListUserReviews = async (req, res) => {
      /*
        #swagger.summary = '사용자가 작성한 리뷰 목록 조회 API';
        #swagger.tags = ['Users']
        #swagger.parameters['userId'] = {
          in: 'path',
          required: true,
          description: '조회할 사용자 ID',
          type: 'number'
        }
    
        #swagger.responses[200] = {
          description: "사용자 리뷰 목록 조회 성공",
          content: {
            "application/json": {
              schema: {
                type: "object",
                properties: {
                  reviews: {
                    type: "array",
                    items: {
                      type: "object",
                      properties: {
                        id: { type: "number", example: 20 },
                        content: { type: "string", example: "친절했고 맛도 괜찮았어요" },
                        score: { type: "number", example: 5 },
                        store: {
                          type: "object",
                          properties: {
                            id: { type: "number", example: 11 },
                            name: { type: "string", example: "홍길동식당" }
                          }
                        },
                        createdAt: { type: "string", example: "2025-01-10T18:30:00+09:00" }
                      }
                    }
                  }
                }
              }
            }
          }
        };
      */
      try {
        const { userId } = req.params;
    
        const reviews = await prisma.review.findMany({
          where: { user_id: Number(userId) },
          include: { store: true },
          orderBy: { id: "desc" },
        });
    
        res.status(StatusCodes.OK).json({ reviews });
      } catch (err) {
        res.status(StatusCodes.BAD_REQUEST).json({ message: err.message });
      }
    };
    
    ```
    
- index.js
    
    ```sql
    import dotenv from "dotenv";
    import express from "express";
    import cors from "cors";
    import morgan from "morgan";
    import cookieParser from "cookie-parser";
    import swaggerAutogen from "swagger-autogen";
    import swaggerUiExpress from "swagger-ui-express";
    
    import {
      handleUserSignUp,
      handleListUserReviews,
    } from "./controllers/user.controller.js";
    import { handleAddStore } from "./controllers/store.controller.js";
    import {
      handleAddReview,
      handleListStoreReviews,
    } from "./controllers/review.controller.js";
    import {
      handleChallengeMission,
      handleListStoreMissions,
      handleListUserMissions,
      handleCompleteMission,
    } from "./controllers/mission.controller.js";
    
    dotenv.config();
    
    const app = express();
    const port = process.env.PORT;
    
    // ------------------- Swagger 설정 -------------------
    
    app.use(
      "/docs",
      swaggerUiExpress.serve,
      swaggerUiExpress.setup(
        {},
        {
          swaggerOptions: {
            url: "/openapi.json",
          },
        }
      )
    );
    
    app.get("/openapi.json", async (req, res, next) => {
      // #swagger.ignore = true
      const options = {
        openapi: "3.0.0",
        disableLogs: true,
        writeOutputFile: false,
      };
      const outputFile = "/dev/null"; // 파일 출력은 사용하지 않습니다.
      const routes = ["./src/index.js"];
      const doc = {
        info: {
          title: "UMC 9th",
          description: "UMC 9th Node.js 테스트 프로젝트입니다.",
        },
        host: "localhost:3000",
      };
    
      try {
        const result = await swaggerAutogen(options)(outputFile, routes, doc);
        res.json(result ? result.data : null);
      } catch (err) {
        next(err);
      }
    });
    
    // ------------------- 공통 응답 헬퍼 -------------------
    
    app.use((req, res, next) => {
      res.success = (success) => {
        return res.json({ resultType: "SUCCESS", error: null, success });
      };
    
      res.error = ({ errorCode = "unknown", reason = null, data = null }) => {
        return res.json({
          resultType: "FAIL",
          error: { errorCode, reason, data },
          success: null,
        });
      };
    
      next();
    });
    
    // ------------------- 미들웨어 적용 -------------------
    
    // 요청 로깅 (morgan)
    app.use(morgan("dev"));
    
    // 쿠키 처리 (cookie-parser)
    app.use(cookieParser());
    
    // CORS 허용
    app.use(cors());
    
    // 정적 파일 접근
    app.use(express.static("public"));
    
    // JSON, URL-encoded 요청 처리
    app.use(express.json());
    app.use(express.urlencoded({ extended: false }));
    
    // ------------------- 라우팅 -------------------
    
    app.get("/", (req, res) => {
      res.send("Hello World!");
    });
    
    /* users */
    // 회원가입
    app.post("/api/v1/users/signup", handleUserSignUp);
    
    // 내가 작성한 리뷰 목록
    app.get("/api/v1/users/:userId/reviews", handleListUserReviews);
    
    // 내가 진행 중인 미션 목록
    app.get("/api/v1/users/:userId/missions", handleListUserMissions);
    
    /* stores */
    // 특정 지역에 가게 추가하기
    app.post("/api/v1/stores", handleAddStore);
    
    // 특정 가게에 리뷰 추가하기
    app.post("/api/v1/stores/:storeId/reviews", handleAddReview);
    
    // 특정 가게 리뷰 조회하기
    app.get("/api/v1/stores/:storeId/reviews", handleListStoreReviews);
    
    // 특정 가게의 미션 목록 조회하기
    app.get("/api/v1/stores/:storeId/missions", handleListStoreMissions);
    
    /* missions */
    // 미션 도전하기
    app.post("/api/v1/missions/:missionId/challenge", handleChallengeMission);
    
    // 진행 중인 미션 완료 처리
    app.patch("/api/v1/missions/:missionId/complete", handleCompleteMission);
    
    // ------------------- 전역 오류 핸들러 -------------------
    
    app.use((err, req, res, next) => {
      if (res.headersSent) {
        return next(err);
      }
    
      res.status(err.statusCode || 500).error({
        errorCode: err.errorCode || "unknown",
        reason: err.reason || err.message || null,
        data: err.data || null,
      });
    });
    
    // 서버 시작
    app.listen(port, () => {
      console.log(`Example app listening on port ${port}`);
    });
    
    ```